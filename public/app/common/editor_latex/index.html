<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editor LaTeX online</title>
    
    <script>
        window.MathJax = {
            loader: {load: ['[tex]/color']},
            tex: {
                inlineMath: [['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']],
                processEscapes: true,
                packages: {'[+]': ['cases', 'mathtools', 'color']}
            },
            svg: {
                fontCache: 'local'
            },
            startup: {
                ready: () => {
                    MathJax.startup.defaultReady();
                    initializeLatexEditor();
                }
            }
        };
    </script>
    <script id="MathJax-script" async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-svg.min.js"></script>

    <style>
        :root {
            --primary-color: #007bff;
            --primary-dark: #0056b3;
            --secondary-color: #6c757d;
            --danger-color: #dc3545;
            --danger-dark: #a71d2a;
            --success-color: #28a745;
            --light-gray: #f8f9fa;
            --medium-gray: #e9ecef;
            --dark-gray: #495057;
            --white: #ffffff;
            --text-color: #212529;
            --border-radius: 12px;
            --box-shadow: 0 8px 24px rgba(0,0,0,0.1);
        }
        * { box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: var(--text-color);
        }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .header { text-align: center; margin-bottom: 30px; color: var(--white); }
        .header h1 { font-size: 2.5rem; margin: 0 0 10px 0; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); }
        .header p { font-size: 1.1rem; opacity: 0.9; margin: 0; }
        .tabs-section { position: relative; background: var(--white); border-radius: var(--border-radius); box-shadow: var(--box-shadow); margin-bottom: 20px; overflow: hidden; }
        
        .search-wrapper { 
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 15px 20px 10px 20px; 
            border-bottom: 1px solid var(--medium-gray); 
        }
        .search-input-container {
            position: relative;
            flex-grow: 1;
        }
        #search-input { 
            width: 100%;
            padding: 12px 40px 12px 12px; 
            border-radius: 8px; 
            border: 2px solid var(--medium-gray); 
            font-size: 1rem; 
            transition: all 0.3s ease; 
        }
        #search-input:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(0,123,255,0.1); }
        #clear-search-btn {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: transparent;
            border: none;
            font-size: 1.8rem;
            color: var(--secondary-color);
            cursor: pointer;
            padding: 0 5px;
            line-height: 1;
            display: none;
        }
        #clear-search-btn:hover { color: var(--dark-gray); }
        #settings-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--dark-gray);
            transition: transform 0.3s, color 0.3s;
            padding: 0 5px;
            flex-shrink: 0;
        }
        #settings-btn:hover {
            color: var(--primary-color);
            transform: rotate(45deg);
        }
        .search-results-view .tabs-container { display: none; }
        .search-results-view .tab-content { display: grid !important; }
        .tabs-container { display: flex; flex-wrap: wrap; background: var(--light-gray); border-bottom: 3px solid var(--medium-gray); }
        .tab-btn { padding: 15px 20px; background: transparent; border: none; cursor: pointer; font-weight: 600; color: var(--dark-gray); transition: all 0.3s ease; position: relative; border-bottom: 3px solid transparent; }
        .tab-btn:hover { background: var(--medium-gray); color: var(--text-color); }
        .tab-btn.active { color: var(--primary-color); border-bottom-color: var(--primary-color); }
        .toolbar-wrapper { padding: 20px; background: var(--white); }
        .tab-content { display: none; gap: 10px; }
        .tab-content.active { display: grid; }
        .toolbar-btn { background: var(--white); border: 2px solid var(--medium-gray); border-radius: 8px; padding: 15px 10px; cursor: pointer; transition: all 0.2s ease; display: flex; align-items: center; justify-content: center; min-height: 60px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .toolbar-btn:hover { border-color: var(--primary-color); background: #f8f9ff; transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,123,255,0.2); }
        .main-content { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .panel { background: var(--white); padding: 25px; border-radius: var(--border-radius); box-shadow: var(--box-shadow); display: flex; flex-direction: column; }
        .panel-title-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 0 0 15px 0;
            border-bottom: 2px solid var(--medium-gray);
            padding-bottom: 10px;
        }
        .panel-title-container h2 { margin: 0; padding: 0; border: none; color: #333; font-size: 1.3rem; }
        #ask-ai-btn {
            padding: 6px 12px;
            background: linear-gradient(45deg, #6c757d, #343a40);
            color: white;
            font-size: 0.9em;
        }
        #latex-input { width: 100%; height: 200px; border: 2px solid var(--medium-gray); border-radius: 8px; padding: 15px; font-family: 'Courier New', monospace; font-size: 14px; resize: vertical; transition: all 0.3s ease; flex-grow: 1; }
        #latex-input:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(0,123,255,0.1); }
        .preview-container { min-height: 200px; border: 2px dashed var(--medium-gray); border-radius: 8px; padding: 20px; display: flex; align-items: center; justify-content: center; background: var(--light-gray); flex-grow: 1; }
        #preview { font-size: 24px; color: var(--text-color); overflow-x: auto; overflow-y: hidden; width: 100%; text-align: center; }
        .copy-options-container { margin-top: 15px; display: flex; justify-content: center; align-items: center; gap: 10px; }
        .copy-options-container label { font-size: 0.9rem; color: var(--dark-gray); font-weight: 500; }
        #delimiter-selector { font-family: inherit; padding: 5px 8px; border-radius: 8px; border: 2px solid var(--medium-gray); background-color: white; transition: border-color 0.2s ease-in-out; }
        #delimiter-selector:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(0,123,255,0.1); }
        .panel-actions { margin-top: 15px; text-align: center; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap; }
        .btn { padding: 10px 20px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; text-decoration: none; display: inline-block; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .btn-sm { padding: 5px 10px; font-size: 0.85rem; }
        .btn-primary { background: linear-gradient(45deg, var(--primary-color), var(--primary-dark)); color: white; }
        .btn-secondary { background: linear-gradient(45deg, var(--secondary-color), #495057); color: white; }
        .btn-danger { background: linear-gradient(45deg, var(--danger-color), var(--danger-dark)); color: white; }
        .btn-success { background: linear-gradient(45deg, var(--success-color), #1e7e34); color: white; }
        .btn:hover { transform: translateY(-3px) scale(1.03); box-shadow: 0 6px 15px rgba(0,0,0,0.2); }
        .copy-feedback { color: var(--primary-color); font-weight: 600; margin-top: 10px; height: 20px; opacity: 0; transition: opacity 0.5s ease; text-align: center; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.6); display: flex; align-items: center; justify-content: center; z-index: 1000; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; padding: 20px; }
        .modal-overlay.active { opacity: 1; visibility: visible; }
        .modal-content { background: var(--white); padding: 30px; border-radius: var(--border-radius); box-shadow: 0 10px 30px rgba(0,0,0,0.2); display: flex; flex-direction: column; max-width: 90vw; max-height: 90vh; text-align: left; transform: scale(0.9); transition: transform 0.3s; width: 600px; }
        .modal-overlay.active .modal-content { transform: scale(1); }
        .modal-content h2, .modal-content h3 { text-align: center; margin-top: 0; color: var(--text-color); }
        .modal-content h3 { margin-top: 20px; margin-bottom: 10px; border-top: 1px solid var(--medium-gray); padding-top: 20px; font-size: 1.1rem;}
        #modal-message { margin: 0 0 20px 0; font-size: 1.1rem; line-height: 1.5; text-align: center; }
        #modal-message img { display: block; margin: 0 auto; }
        #alert-modal-message p { margin: 0 0 10px 0; }
        .modal-buttons { display: flex; justify-content: center; gap: 15px; margin-top: 25px;}
        .modal-content .form-group { margin-bottom: 20px; }
        .modal-content .form-group label { display: block; font-weight: 600; margin-bottom: 8px; }
        .modal-content .form-group input, .modal-content .form-group textarea { width: 100%; padding: 10px; border-radius: 8px; border: 2px solid var(--medium-gray); font-size: 1rem; }
        #ai-modal .form-group textarea { resize: vertical; font-family: 'Segoe UI', sans-serif; }
        #ai-modal .form-group textarea[readonly] { background-color: var(--light-gray); cursor: text; }
        #modal-feedback { font-size: 0.9em; height: 20px; text-align: center; }
        .modal-body { overflow-y: auto; padding-right: 15px; margin-right: -15px;}
        .menu-list { list-style: none; padding: 0; margin: 0; }
        .menu-list li { display: flex; align-items: center; padding: 8px; border-radius: 8px; transition: background-color 0.2s; }
        .menu-list li:nth-child(odd) { background-color: var(--light-gray); }
        .menu-list-item-name { font-weight: 500; margin-left: 10px; }
        .footer { text-align: center; padding: 30px 20px; color: white; opacity: 0.9; font-size: 0.9rem; }
        .footer a { color: #ffffff; font-weight: 600; text-decoration: none; }
        .footer a:hover { text-decoration: underline; }
        #clear-recents-btn-container { text-align: right; margin-top: 10px; }
        .matrix-builder {
            border: 2px solid var(--medium-gray); border-radius: var(--border-radius); padding: 10px; grid-column: 1 / -1; display: flex; flex-wrap: wrap; align-items: center; justify-content: center; gap: 10px 15px; background-color: var(--light-gray);
        }
        .matrix-builder-group { display: flex; align-items: center; gap: 5px; }
        .matrix-builder-group label { font-size: 0.9em; font-weight: 500; color: var(--dark-gray); white-space: nowrap; }
        .matrix-builder-group input, .matrix-builder-group select { padding: 6px; border-radius: 8px; border: 2px solid var(--medium-gray); font-size: 0.9rem; width: 65px; }
        .matrix-builder-group select { width: auto; min-width: 140px; }
        .matrix-builder-delimiters { display: flex; align-items: center; gap: 8px; }
        .matrix-builder-delimiters .btn { padding: 6px 14px; font-size: 1.1rem; }

        @media (max-width: 900px) { .main-content { grid-template-columns: 1fr; } }
        @media (max-width: 600px) {
            .header h1 { font-size: 2rem; } .tab-btn { padding: 12px 15px; font-size: 14px; } .container { padding: 10px; } .modal-content { padding: 20px; } .matrix-builder { justify-content: flex-start; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>Editor LaTeX online</h1>
            <p>Crea fórmulas matemáticas visualmente, cópialas o descárgalas como imagen.</p>
        </header>

        <div id="tabs-section" class="tabs-section">
            <div class="search-wrapper">
                <div class="search-input-container">
                    <input type="search" id="search-input" placeholder="Buscar por descripción o código (ej: fracción, \int)..." autocomplete="off">
                    <button id="clear-search-btn" title="Borrar búsqueda">&times;</button>
                </div>
                <button id="settings-btn" title="Personalizar menú">⚙️</button>
            </div>
            <div id="tabs-container" class="tabs-container"></div>
            <div class="toolbar-wrapper">
                <div id="toolbar"></div>
            </div>
        </div>

        <div class="main-content">
             <div class="panel">
                <div class="panel-title-container">
                    <h2>Código LaTeX</h2>
                    <button id="ask-ai-btn" class="btn btn-sm" title="Pedir fórmula a la IA">✨ Asistente IA</button>
                </div>
                <textarea id="latex-input" placeholder="Escribe aquí tu código... \frac{a}{b}" spellcheck="false"></textarea>
                <div class="copy-options-container">
                    <label for="delimiter-selector">Copiar con delimitadores:</label>
                    <select id="delimiter-selector" class="mathjax_ignore">
                        <option value="none" selected>Sin delimitadores</option>
                        <option value="parentheses">\(...\)</option>
                        <option value="brackets">\[...\]</option>
                        <option value="double_dollar">$$...$$</option>
                        <option value="single_dollar">$...$</option>
                    </select>
                </div>
                <div class="panel-actions">
                      <button id="copy-button" class="btn btn-primary">Copiar código LaTeX</button>
                      <button id="clear-button" class="btn btn-secondary">Borrar código</button>
                      <button id="insert-button" class="btn btn-success">Insertar en eXeLearning</button>
                </div>
                <div id="copy-code-feedback" class="copy-feedback"></div>
            </div>
            <div class="panel">
                <div class="panel-title-container"><h2>Previsualización</h2></div>
                <div class="preview-container">
                    <div id="preview"></div>
                </div>
                <div class="panel-actions">
                    <button id="view-image-button" class="btn btn-success">Visualizar imagen</button>
                </div>
                 <div id="copy-image-feedback" class="copy-feedback"></div>
            </div>
        </div>
    </div>
    
    <footer id="page-footer" class="footer"></footer>

    <!-- Modales -->
    <div id="image-modal" class="modal-overlay">
        <div class="modal-content">
            <div id="modal-message"></div>
            <div id="modal-buttons" class="modal-buttons"></div>
        </div>
    </div>
    <div id="settings-modal" class="modal-overlay">
        <div class="modal-content">
            <h2>Gestionar menús</h2>
            <div class="modal-body">
                <h3>Menús disponibles</h3>
                <ul id="available-menus-list" class="menu-list"><li>Cargando...</li></ul>
                <div class="modal-buttons" style="justify-content: flex-end; margin-top: 10px;">
                    <button id="reload-menus-list-btn" class="btn btn-sm btn-secondary">Recargar lista</button>
                </div>
                <h3>Carga personalizada</h3>
                <div class="form-group">
                    <label for="url-input">Cargar menú desde URL externa</label>
                    <input type="url" id="url-input" placeholder="https://ejemplo.com/formulas.json">
                </div>
                <div class="form-group">
                    <label for="file-input">Cargar menú desde archivo local</label>
                    <input type="file" id="file-input" accept=".json,application/json">
                </div>
                 <h3>Acciones</h3>
                <div id="modal-feedback" style="margin-bottom: 15px;"></div>
                <div class="modal-buttons" style="flex-wrap: wrap;">
                    <button id="clear-cache-btn" class="btn btn-secondary">Limpiar caché y recargar</button>
                </div>
            </div>
            <div class="modal-buttons">
                <button id="close-settings-btn" class="btn btn-primary">Cerrar</button>
            </div>
        </div>
    </div>
    <div id="ai-modal" class="modal-overlay">
        <div class="modal-content">
            <h2>Asistente de Fórmulas IA</h2>
            <div class="modal-body">
                <p style="text-align: center; margin-bottom: 20px;">Describe la fórmula o expresión matemática que necesitas. El asistente generará una instrucción (prompt) para que la uses en un modelo de IA como ChatGPT.</p>
                <div class="form-group">
                    <label for="ai-user-prompt">1. Describe tu fórmula:</label>
                    <textarea id="ai-user-prompt" rows="3" placeholder="Ej.: Ecuación cuadrática con a=1, b=14 y c=-4"></textarea>
                </div>
                <div class="modal-buttons" style="margin-top: 0; margin-bottom: 20px;">
                     <button id="generate-ai-prompt-btn" class="btn btn-secondary">2. Generar instrucción para IA</button>
                </div>
                <div class="form-group">
                    <label for="ai-generated-prompt">3. Instrucción generada:</label>
                    <textarea id="ai-generated-prompt" rows="4" readonly placeholder="Aquí aparecerá la instrucción para la IA..."></textarea>
                </div>
                 <div id="ai-feedback" class="copy-feedback" style="height: auto; margin-bottom: 15px; margin-top: -10px;"></div>
            </div>
            <div class="modal-buttons">
                <a id="open-chatgpt-btn" href="#" target="_blank" class="btn btn-primary" style="display: none;">Abrir en ChatGPT</a>
                <button id="copy-ai-prompt-btn" class="btn btn-success" style="display: none;">Copiar para otra IA</button>
                <button id="close-ai-modal-btn" class="btn btn-secondary">Cerrar</button>
            </div>
        </div>
    </div>
    <div id="alert-modal" class="modal-overlay">
        <div class="modal-content">
            <h2 id="alert-modal-title" style="text-align: center;"></h2>
            <div id="alert-modal-message" style="font-size: 1rem; line-height: 1.5;"></div>
            <div class="modal-buttons">
                <button id="alert-modal-close-btn" class="btn btn-primary">Entendido</button>
            </div>
        </div>
    </div>

    <script>
        async function initializeLatexEditor() {
            // --- REFERENCIAS AL DOM ---
            const latexInput = document.getElementById('latex-input');
            const preview = document.getElementById('preview');

// Prefill LaTeX code if coming from PasteMathDialog
try {
    if (window.opener && window.opener.PasteMathDialog && window.opener.PasteMathDialog.mathEditor && window.opener.PasteMathDialog.mathEditor.field) {
        const parentLatex = window.opener.PasteMathDialog.mathEditor.field.val().trim();
        if (parentLatex) {
            latexInput.value = parentLatex;
            updatePreview(); // ensure preview refresh
        }
    }
} catch (err) {
    console.warn('No se pudo obtener código del diálogo padre:', err);
}

            const copyButton = document.getElementById('copy-button');
            const clearButton = document.getElementById('clear-button');
            const insertButton = document.getElementById('insert-button');
            const viewImageButton = document.getElementById('view-image-button');
            const delimiterSelector = document.getElementById('delimiter-selector');
            const copyCodeFeedback = document.getElementById('copy-code-feedback');
            const tabsContainer = document.getElementById('tabs-container');
            const toolbar = document.getElementById('toolbar');
            const searchInput = document.getElementById('search-input');
            const clearSearchBtn = document.getElementById('clear-search-btn');
            const settingsBtn = document.getElementById('settings-btn');
            // Modales
            const settingsModal = document.getElementById('settings-modal');
            const closeSettingsBtn = document.getElementById('close-settings-btn');
            const urlInput = document.getElementById('url-input');
            const fileInput = document.getElementById('file-input');
            const modalFeedback = document.getElementById('modal-feedback');
            const alertModal = document.getElementById('alert-modal');
            const alertModalTitle = document.getElementById('alert-modal-title');
            const alertModalMessage = document.getElementById('alert-modal-message');
            const alertModalCloseBtn = document.getElementById('alert-modal-close-btn');
            const availableMenusList = document.getElementById('available-menus-list');
            const reloadMenusListBtn = document.getElementById('reload-menus-list-btn');
            const clearCacheBtn = document.getElementById('clear-cache-btn');
            // Modal de IA
            const askAiBtn = document.getElementById('ask-ai-btn');
            const aiModal = document.getElementById('ai-modal');
            const closeAiModalBtn = document.getElementById('close-ai-modal-btn');
            const aiUserPrompt = document.getElementById('ai-user-prompt');
            const generateAiPromptBtn = document.getElementById('generate-ai-prompt-btn');
            const aiGeneratedPrompt = document.getElementById('ai-generated-prompt');
            const openChatGptBtn = document.getElementById('open-chatgpt-btn');
            const copyAiPromptBtn = document.getElementById('copy-ai-prompt-btn');
            const aiFeedback = document.getElementById('ai-feedback');
            
            // --- CONFIGURACIÓN ---
            const GITHUB_API_URL = 'https://api.github.com/repos/jjdeharo/app/contents/mat/editor_latex/docs';
            const DEFAULT_MENU_GITHUB_URL = 'https://raw.githubusercontent.com/jjdeharo/app/main/mat/editor_latex/formulas.json';
            const DEFAULT_MENU_LOCAL_URL = './formulas.json';
            const MAX_RECENTS = 12;

            // --- ESTADO DE LA APLICACIÓN ---
            let loadedMenus = new Map();
            let menuCache = new Map();
            let githubMenuListCache = null;
            let recentSymbols = [];
            
            // --- GESTIÓN DE DATOS Y ESTADO (Recientes y Menús) ---
            const loadRecents = () => { recentSymbols = JSON.parse(localStorage.getItem('latexRecents')) || []; };
            const saveRecents = () => { localStorage.setItem('latexRecents', JSON.stringify(recentSymbols)); };
            const clearRecents = () => { recentSymbols = []; localStorage.removeItem('latexRecents'); rebuildToolbarAndUI(); };
            const createRecentsTab = () => {
                if (document.querySelector('[data-tab="recientes"]')) return;
                const recentsTabButton = document.createElement('button');
                recentsTabButton.className = 'tab-btn';
                recentsTabButton.dataset.tab = 'recientes';
                recentsTabButton.textContent = 'Recientes';
                tabsContainer.prepend(recentsTabButton);
                const recentsContentDiv = document.createElement('div');
                recentsContentDiv.id = 'tab-recientes';
                recentsContentDiv.className = 'tab-content';
                toolbar.prepend(recentsContentDiv);
            };
            const trackSymbolUsage = (latexCode) => {
                const wasEmpty = recentSymbols.length === 0;
                recentSymbols = recentSymbols.filter(item => item !== latexCode);
                recentSymbols.unshift(latexCode);
                if (recentSymbols.length > MAX_RECENTS) recentSymbols = recentSymbols.slice(0, MAX_RECENTS);
                saveRecents();
                if (wasEmpty) {
                    rebuildToolbarAndUI();
                } else {
                    const recentsContent = document.getElementById('tab-recientes');
                    if (recentsContent && recentsContent.classList.contains('active')) {
                        renderTabContent('recientes', getAllCategories());
                    }
                }
            };
            const saveAddedMenusToStorage = () => {
                const added = Array.from(loadedMenus.values())
                    .filter(m => m.source !== 'default' && m.source !== 'localfile')
                    .map(m => ({ id: m.id, url: m.url, source: m.source, name: m.name }));
                localStorage.setItem('latexAddedMenus', JSON.stringify(added));
            };
            const loadAddedMenusFromStorage = () => { return JSON.parse(localStorage.getItem('latexAddedMenus')) || []; };

            // --- LÓGICA DE CARGA Y GESTIÓN DE MENÚS ---
            const fetchMenuData = async (url) => {
                if (menuCache.has(url)) return menuCache.get(url);
                try {
                    const response = await fetch(url);
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    const data = await response.json();
                    menuCache.set(url, data);
                    return data;
                } catch (error) {
                    console.error(`Error fetching menu from ${url}:`, error);
                    showModalFeedback(`Error al cargar ${url}`, true);
                    return null;
                }
            };
            const addMenu = async (menuInfo) => {
                if (loadedMenus.has(menuInfo.id)) return;
                const data = await fetchMenuData(menuInfo.url);
                if (data) {
                    loadedMenus.set(menuInfo.id, { ...menuInfo, data });
                    rebuildToolbarAndUI();
                    saveAddedMenusToStorage();
                }
            };
            const removeMenu = (menuId) => {
                if (loadedMenus.has(menuId) && loadedMenus.get(menuId).source !== 'default') {
                    loadedMenus.delete(menuId);
                    rebuildToolbarAndUI();
                    saveAddedMenusToStorage();
                }
            };
            const getAllCategories = () => {
                const allCategories = new Map();
                const menuOrder = ['default', 'github', 'url', 'localfile'];
                const sortedMenus = Array.from(loadedMenus.values()).sort((a,b) => menuOrder.indexOf(a.source) - menuOrder.indexOf(b.source));
                for (const menu of sortedMenus) {
                    if (!menu.data || !menu.data.categorias) continue;
                    for (const categoria of menu.data.categorias) {
                        if (!allCategories.has(categoria.id)) {
                             allCategories.set(categoria.id, { ...categoria, elementos: [...categoria.elementos] });
                        } else {
                            allCategories.get(categoria.id).elementos.push(...categoria.elementos);
                        }
                    }
                }
                return allCategories;
            };
            const rebuildToolbarAndUI = () => {
                tabsContainer.innerHTML = '';
                toolbar.innerHTML = '';
                const allCategories = getAllCategories();
                let isFirstTab = true;
                if (recentSymbols.length > 0) {
                    createRecentsTab();
                    tabsContainer.querySelector('[data-tab="recientes"]').classList.add('active');
                    toolbar.querySelector('#tab-recientes').classList.add('active');
                    isFirstTab = false;
                }
                allCategories.forEach((categoria) => {
                    const tabButton = document.createElement('button');
                    tabButton.className = 'tab-btn';
                    tabButton.dataset.tab = categoria.id;
                    tabButton.textContent = categoria.nombre;
                    tabsContainer.appendChild(tabButton);
                    const contentDiv = document.createElement('div');
                    contentDiv.id = `tab-${categoria.id}`;
                    contentDiv.className = 'tab-content';
                    toolbar.appendChild(contentDiv);
                    if (isFirstTab) {
                        tabButton.classList.add('active');
                        contentDiv.classList.add('active');
                        isFirstTab = false;
                    }
                });
                const activeTab = tabsContainer.querySelector('.tab-btn.active');
                if (activeTab) {
                    renderTabContent(activeTab.dataset.tab, allCategories);
                }
                loadAndDisplayAvailableMenus();
            };
            const initializeApp = async () => {
                loadRecents();
                loadedMenus.clear();
                menuCache.clear();
                githubMenuListCache = null;
                let baseMenuData;
                try {
                    const response = await fetch(DEFAULT_MENU_LOCAL_URL);
                    if (!response.ok) throw new Error("Local default not found");
                    baseMenuData = await response.json();
                } catch (e) {
                    baseMenuData = await fetchMenuData(DEFAULT_MENU_GITHUB_URL);
                }
                if(baseMenuData) {
                    loadedMenus.set('formulas.json', { id: 'formulas.json', url: DEFAULT_MENU_GITHUB_URL, source: 'default', name: 'Base', data: baseMenuData });
                }
                const previouslyAdded = loadAddedMenusFromStorage();
                for (const menuInfo of previouslyAdded) {
                    const data = await fetchMenuData(menuInfo.url);
                    if (data) loadedMenus.set(menuInfo.id, { ...menuInfo, data });
                }
                rebuildToolbarAndUI();
                updatePreview();
                addFooter();
            };

            // --- LÓGICA DE LA INTERFAZ DE USUARIO (UI) ---
            const renderAvailableMenus = (menuItemsMap) => {
                availableMenusList.innerHTML = '';
                if(menuItemsMap.size === 0) {
                     availableMenusList.innerHTML = '<li>No se encontraron menús.</li>';
                     return;
                }
                menuItemsMap.forEach(menu => {
                    const li = document.createElement('li');
                    if (menu.source === 'error') {
                        li.textContent = menu.name;
                        li.style.color = 'var(--danger-color)'; li.style.justifyContent = 'center'; li.style.fontStyle = 'italic';
                        availableMenusList.appendChild(li);
                        return;
                    }
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.id = `menu-checkbox-${menu.id}`;
                    checkbox.checked = loadedMenus.has(menu.id);
                    checkbox.dataset.id = menu.id;
                    checkbox.dataset.url = menu.url;
                    checkbox.dataset.name = menu.name;
                    checkbox.dataset.source = menu.source;
                    const label = document.createElement('label');
                    label.htmlFor = `menu-checkbox-${menu.id}`;
                    label.className = 'menu-list-item-name';
                    label.textContent = menu.name || menu.id;
                    if(menu.source === 'default') {
                        checkbox.disabled = true;
                        label.innerHTML += ` <em style="font-weight:normal; font-size:0.9em; color: var(--secondary-color)">(Base)</em>`;
                    }
                    li.appendChild(checkbox);
                    li.appendChild(label);
                    availableMenusList.appendChild(li);
                });
            };
            const loadAndDisplayAvailableMenus = async (forceRefetch = false) => {
                if (!forceRefetch && githubMenuListCache) {
                    renderAvailableMenus(githubMenuListCache);
                    return;
                }
                availableMenusList.innerHTML = '<li>Cargando...</li>';
                const menuItems = new Map();
                const baseMenu = loadedMenus.get('formulas.json');
                if(baseMenu) menuItems.set(baseMenu.id, { ...baseMenu });
                try {
                    const response = await fetch(GITHUB_API_URL);
                    if (!response.ok) throw new Error(`Error al contactar con GitHub: ${response.statusText}`);
                    const files = await response.json();
                    if (!Array.isArray(files)) throw new Error('La respuesta de la API de GitHub no es válida.');
                    files.filter(file => file.name.endsWith('.json') && file.type === 'file').forEach(file => {
                         menuItems.set(file.name, { id: file.name, name: file.name.replace('.json', '').replace(/_/g, ' ').replace(/^\w/, c => c.toUpperCase()), url: file.download_url, source: 'github' });
                    });
                } catch(e) {
                    menuItems.set('error-github-api', { id: 'error-github-api', name: `No se pudo cargar la lista de menús.`, source: 'error' });
                }
                for (const menu of loadedMenus.values()){
                     if (!menuItems.has(menu.id)) menuItems.set(menu.id, {...menu});
                }
                githubMenuListCache = menuItems;
                renderAvailableMenus(githubMenuListCache);
            };

            function showAlert(title, htmlMessage) {
                alertModalTitle.textContent = title;
                alertModalMessage.innerHTML = htmlMessage;
                alertModal.classList.add('active');
            }
            function hideAlert() { alertModal.classList.remove('active'); }
            function showImageModal(message, buttons) {
                document.getElementById('modal-message').innerHTML = message;
                const modalButtons = document.getElementById('modal-buttons');
                modalButtons.innerHTML = '';
                buttons.forEach(btnInfo => {
                    const button = document.createElement('button');
                    button.textContent = btnInfo.text;
                    button.className = `btn ${btnInfo.class}`;
                    button.onclick = () => { if(btnInfo.action) btnInfo.action(); document.getElementById('image-modal').classList.remove('active'); };
                    modalButtons.appendChild(button);
                });
                document.getElementById('image-modal').classList.add('active');
            }
            function openSettingsModal() { loadAndDisplayAvailableMenus(); settingsModal.classList.add('active'); }
            function closeSettingsModal() { settingsModal.classList.remove('active'); }
            function showModalFeedback(message, isError = false) {
                modalFeedback.textContent = message;
                modalFeedback.style.color = isError ? 'var(--danger-color)' : 'var(--success-color)';
                setTimeout(() => modalFeedback.textContent = '', 3000);
            }
            function openAiModal() { aiModal.classList.add('active'); }
            function closeAiModal() { aiModal.classList.remove('active'); }
            function showAiFeedback(message, isError = false) {
                aiFeedback.textContent = message;
                aiFeedback.style.color = isError ? 'var(--danger-color)' : 'var(--success-color)';
                aiFeedback.style.opacity = '1';
                setTimeout(() => { if (aiFeedback.textContent === message) { aiFeedback.style.opacity = '0'; } }, 4000);
            }
            function generateAiPrompt() {
                const userDescription = aiUserPrompt.value.trim();
                if (!userDescription) {
                    showAiFeedback('Por favor, describe la fórmula que necesitas.', true);
                    return;
                }
                const prompt = `Proporciona el código LaTeX para la siguiente descripción matemática: "${userDescription}". El resultado debe ser únicamente el código LaTeX, sin explicaciones adicionales ni los delimitadores como $$ o \\[ \\]. Debe estar listo para ser copiado y pegado directamente en un editor LaTeX.`;
                aiGeneratedPrompt.value = prompt;
                openChatGptBtn.href = `https://chatgpt.com/?q=${encodeURIComponent(prompt)}`;
                openChatGptBtn.style.display = 'inline-block';
                copyAiPromptBtn.style.display = 'inline-block';
                showAiFeedback('Instrucción generada. Ya puedes usar los botones.', false);
            }
            function copyAiPrompt() {
                if (!aiGeneratedPrompt.value) return;
                navigator.clipboard.writeText(aiGeneratedPrompt.value);
                showAiFeedback('¡Instrucción copiada al portapapeles!', false);
            }
             function updatePreview() {
                preview.innerHTML = latexInput.value.trim() === "" ? "" : `$$${latexInput.value.trim()}$$`;
                MathJax.typesetPromise([preview]).catch(() => { preview.innerHTML = `<span style="color:red;">Error de sintaxis</span>`; });
            }
            function insertAtCursor(textToInsert) {
                const startPos = latexInput.selectionStart;
                latexInput.value = latexInput.value.substring(0, startPos) + textToInsert + latexInput.value.substring(latexInput.selectionEnd);
                let cursorPos = textToInsert.indexOf('{}');
                latexInput.selectionStart = latexInput.selectionEnd = startPos + (cursorPos !== -1 ? cursorPos + 1 : textToInsert.length);
                latexInput.focus();
                updatePreview();
                if (textToInsert.includes('\\begin{')) return;
                trackSymbolUsage(textToInsert);
            }
            function generateImage(callback) {
                const svgElement = preview.querySelector('svg');
                if (!svgElement) { showImageModal('<p>No hay fórmula para capturar.</p>', [{text: 'OK', class: 'btn-primary'}]); return; }
                const svgString = new XMLSerializer().serializeToString(svgElement);
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    const padding = 20;
                    canvas.width = svgElement.width.baseVal.value + padding * 2;
                    canvas.height = svgElement.height.baseVal.value + padding * 2;
                    const ctx = canvas.getContext('2d');
                    ctx.fillStyle = 'white'; ctx.fillRect(0, 0, canvas.width, canvas.height);
                    ctx.drawImage(img, padding, padding, svgElement.width.baseVal.value, svgElement.height.baseVal.value);
                    URL.revokeObjectURL(img.src);
                    callback(canvas);
                };
                img.src = URL.createObjectURL(new Blob([svgString], {type: "image/svg+xml;charset=utf-8"}));
            }
            function handleViewImage() {
                generateImage(canvas => {
                    const message = `<div><img src="${canvas.toDataURL('image/png')}" style="max-width: 100%; max-height: 80vh;"><p>Clic derecho sobre la imagen para guardarla o copiarla.</p></div>`;
                    showImageModal(message, [{text: 'Cerrar', class: 'btn-secondary'}]);
                });
            }
            function createMatrixBuilderUI(elemento) {
                const container = document.createElement('div');
                container.className = 'matrix-builder';
                container.dataset.title = elemento.title || 'Matriz personalizada';
                container.innerHTML = `<div class="matrix-builder-group"><label for="mb-rows">Filas:</label><input type="number" id="mb-rows" value="2" min="1" max="20"></div><div class="matrix-builder-group"><label for="mb-cols">Columnas:</label><input type="number" id="mb-cols" value="2" min="1" max="20"></div><div class="matrix-builder-group"><label for="mb-fill">Rellenar:</label><select id="mb-fill"><option value="subscripts">Subíndices (a, b...)</option><option value="zeros">Ceros (0)</option><option value="ones">Unos (1)</option><option value="vars">Variables (a, b, c...)</option><option value="numbers">Números (1, 2, 3...)</option><option value="empty">Vacío ({})</option></select></div><div class="matrix-builder-delimiters"><button class="btn" data-delimiter="pmatrix">()</button><button class="btn" data-delimiter="bmatrix">[]</button><button class="btn" data-delimiter="vmatrix">||</button><button class="btn" data-delimiter="Vmatrix">|||</button></div>`;
                container.querySelector('.matrix-builder-delimiters').addEventListener('click', (e) => {
                    const button = e.target.closest('button');
                    if (!button) return;
                    const rows = parseInt(container.querySelector('#mb-rows').value, 10);
                    const cols = parseInt(container.querySelector('#mb-cols').value, 10);
                    insertAtCursor(generateMatrixCode(rows, cols, container.querySelector('#mb-fill').value, button.dataset.delimiter));
                });
                return container;
            }
            function generateMatrixCode(rows, cols, fillType, delimiter) {
                if (isNaN(rows) || isNaN(cols) || rows < 1 || cols < 1) return '';
                let content = '', counter = 0;
                for (let i = 1; i <= rows; i++) {
                    for (let j = 1; j <= cols; j++) {
                        let cell;
                        switch(fillType) {
                            case 'subscripts': cell = `a_{${i}${j}}`; break;
                            case 'zeros': cell = '0'; break; case 'ones': cell = '1'; break;
                            case 'vars': cell = 'abcdefghijklmnopqrstuvwxyz'[counter % 26]; counter++; break;
                            case 'numbers': cell = (counter + 1).toString(); counter++; break;
                            case 'empty': cell = '{}'; break;
                            default: cell = '';
                        }
                        content += cell + (j < cols ? ' & ' : '');
                    }
                    if (i < rows) content += ' \\\\\n  ';
                }
                return `\\begin{${delimiter}}\n  ${content}\n\\end{${delimiter}}`;
            }
            function normalizeString(str) { return typeof str !== 'string' ? '' : str.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, ""); }
            function renderTabContent(tabId, allCategories) {
                const contentDiv = document.getElementById(`tab-${tabId}`);
                if (!contentDiv) return;
                contentDiv.innerHTML = '';
                let elementsToRender = [], gridColumns = "repeat(auto-fill, minmax(80px, 1fr))";
                if (tabId === 'recientes') {
                    if (recentSymbols.length === 0) {
                         contentDiv.innerHTML = `<p style="color: var(--dark-gray); grid-column: 1 / -1; text-align:center;">Aún no hay símbolos recientes.</p><div id="clear-recents-btn-container" style="grid-column: 1 / -1;"><button id="clear-recents-btn" class="btn btn-sm btn-danger">Borrar recientes</button></div>`;
                         document.getElementById('clear-recents-btn').onclick = clearRecents;
                         return;
                    }
                    recentSymbols.forEach(latexCode => {
                        for (const menu of loadedMenus.values()) {
                            if (!menu.data || !menu.data.categorias) continue;
                            for (const categoria of menu.data.categorias) {
                                const found = categoria.elementos.find(el => el && el.latex === latexCode);
                                if (found) { elementsToRender.push(found); return; }
                            }
                        }
                    });
                } else {
                    const categoria = allCategories.get(tabId);
                    if (categoria) { elementsToRender = categoria.elementos; gridColumns = categoria.grid_template_columns || gridColumns; }
                }
                contentDiv.style.gridTemplateColumns = gridColumns;
                elementsToRender.forEach(elemento => {
                    if (!elemento) return;
                    if (elemento.type === 'custom_matrix') contentDiv.appendChild(createMatrixBuilderUI(elemento));
                    else if (elemento.latex) {
                        const button = document.createElement('button');
                        button.className = 'toolbar-btn';
                        button.dataset.latex = elemento.latex;
                        button.title = elemento.title;
                        button.innerHTML = `\\(${elemento.display || elemento.latex}\\)`;
                        contentDiv.appendChild(button);
                    }
                });
                if (tabId === 'recientes' && recentSymbols.length > 0) {
                     const clearBtnContainer = document.createElement('div');
                     clearBtnContainer.id = 'clear-recents-btn-container';
                     clearBtnContainer.style.gridColumn = '1 / -1';
                     clearBtnContainer.innerHTML = `<button id="clear-recents-btn" class="btn btn-sm btn-danger">Borrar recientes</button>`;
                     clearBtnContainer.firstElementChild.onclick = clearRecents;
                     contentDiv.appendChild(clearBtnContainer);
                }
                MathJax.typesetPromise(contentDiv.querySelectorAll('.toolbar-btn'));
            }
            function handleTabSwitch(event) {
                const button = event.target.closest('.tab-btn');
                if (!button) return;
                tabsContainer.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
                toolbar.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                button.classList.add('active');
                const tabId = button.dataset.tab;
                document.getElementById(`tab-${tabId}`).classList.add('active');
                renderTabContent(tabId, getAllCategories());
            }
            let allTabsRenderedForSearch = false;
            searchInput.addEventListener('input', (e) => {
                const hasText = e.target.value.length > 0;
                clearSearchBtn.style.display = hasText ? 'block' : 'none';
                const query = normalizeString(e.target.value.trim());
                tabsContainer.parentElement.classList.toggle('search-results-view', query.length > 0);
                if (query.length > 0) {
                    if (!allTabsRenderedForSearch) {
                        const allCategories = getAllCategories();
                        allCategories.forEach(cat => renderTabContent(cat.id, allCategories));
                        allTabsRenderedForSearch = true;
                    }
                    toolbar.querySelectorAll('.toolbar-btn, .matrix-builder').forEach(el => {
                        const title = normalizeString(el.title || el.dataset.title);
                        const latex = normalizeString(el.dataset.latex);
                        el.style.display = (title.includes(query) || latex.includes(query)) ? 'flex' : 'none';
                    });
                } else {
                     allTabsRenderedForSearch = false;
                     toolbar.querySelectorAll('.toolbar-btn, .matrix-builder').forEach(el => { el.style.display = 'flex'; });
                     rebuildToolbarAndUI();
                }
            });
            function addFooter() {
                document.getElementById('page-footer').innerHTML = `<p style="margin-bottom: 10px;"><a href="https://labia.tiddlyhost.com" target="_blank" rel="noopener noreferrer">Laboratorio de aplicaciones educativas</a> | <a href="https://bilateria.org" target="_blank" rel="noopener noreferrer">Aplicación hecha por Juan José de Haro</a></p><p style="margin-bottom: 10px;"><a href="https://creativecommons.org/licenses/by-sa/4.0/deed.es" target="_blank" rel="noopener noreferrer">Licencia Creative Commons BY-SA</a></p><p style="margin-top: 20px; font-size: 0.8em; opacity: 0.7;">v4.7</p>`;
            }

            // --- EVENT LISTENERS ---
            latexInput.addEventListener('input', updatePreview);
            toolbar.addEventListener('click', (event) => { const btn = event.target.closest('.toolbar-btn'); if (btn && btn.dataset.latex) insertAtCursor(btn.dataset.latex); });
            tabsContainer.addEventListener('click', handleTabSwitch);
            clearSearchBtn.addEventListener('click', () => { searchInput.value = ''; searchInput.dispatchEvent(new Event('input', { bubbles: true })); searchInput.focus(); });
            copyButton.addEventListener('click', () => {
                const rawLatex = latexInput.value.trim();
                if (!rawLatex) return;
                let textToCopy;
                switch (delimiterSelector.value) {
                    case 'parentheses': textToCopy = `\\(${rawLatex}\\)`; break;
                    case 'brackets': textToCopy = `\\[\n${rawLatex}\n\\]`; break;
                    case 'double_dollar': textToCopy = `$$\n${rawLatex}\n$$`; break;
                    case 'single_dollar': textToCopy = `$${rawLatex}$`; break;
                    default: textToCopy = rawLatex;
                }
                navigator.clipboard.writeText(textToCopy);
                copyCodeFeedback.textContent = '¡Código copiado!';
                copyCodeFeedback.style.opacity = '1';
                setTimeout(() => { copyCodeFeedback.style.opacity = '0'; }, 2000);
            });
            clearButton.addEventListener('click', () => { latexInput.value = ''; latexInput.focus(); updatePreview(); });

insertButton.addEventListener('click', () => {
    const rawLatex = latexInput.value.trim();
    if (!rawLatex) return;
    try {
        if (window.opener && window.opener.PasteMathDialog && window.opener.PasteMathDialog.mathEditor && window.opener.PasteMathDialog.mathEditor.field) {
            window.opener.PasteMathDialog.mathEditor.field.val(rawLatex);
        }
    } catch (err) {
        console.error('Error al insertar en eXeLearning:', err);
    }
    window.close();
});

            viewImageButton.addEventListener('click', handleViewImage);
            document.getElementById('image-modal').addEventListener('click', (e) => { if (e.target.id === 'image-modal') document.getElementById('image-modal').classList.remove('active'); });
            settingsBtn.addEventListener('click', openSettingsModal);
            closeSettingsBtn.addEventListener('click', closeSettingsModal);
            settingsModal.addEventListener('click', (e) => { if(e.target === settingsModal) closeSettingsModal(); });
            urlInput.addEventListener('change', () => { if(urlInput.value) { addMenu({id: urlInput.value, url: urlInput.value, source: 'url', name: urlInput.value}).then(() => loadAndDisplayAvailableMenus()); urlInput.value = ''; } });
            
fileInput.addEventListener('change', () => {
    if (fileInput.files.length === 0) return;
    const [file] = fileInput.files;
    const reader = new FileReader();
    reader.onload = (e) => {
        let jsonText = e.target.result;
        let parsed = null;
        try {
            parsed = JSON.parse(jsonText);
        } catch (parseErr) {
            console.error('Error parseando JSON local:', parseErr);
            showModalFeedback('El archivo no es un JSON válido (' + parseErr.message + ')', true);
            return;
        }
        try {
            loadedMenus.set(file.name, { id: file.name, url: file.name, source: 'localfile', name: file.name, data: parsed });
            rebuildToolbarAndUI();
            showModalFeedback('Menú cargado correctamente.', false);
        } catch (logicErr) {
            console.error('Error al integrar el menú:', logicErr);
            showModalFeedback('Error al procesar el menú (' + logicErr.message + ')', true);
        }
    };
    reader.readAsText(file, 'utf-8');
    fileInput.value = '';
});
            availableMenusList.addEventListener('change', (e) => { if(e.target.type !== 'checkbox') return; const ds = e.target.dataset; if (e.target.checked) addMenu(ds); else removeMenu(ds.id); });
            reloadMenusListBtn.addEventListener('click', () => loadAndDisplayAvailableMenus(true));
            clearCacheBtn.addEventListener('click', () => { menuCache.clear(); githubMenuListCache = null; showModalFeedback('Caché limpiada. Los menús se recargarán desde su origen.'); initializeApp(); });
            alertModalCloseBtn.addEventListener('click', hideAlert);
            alertModal.addEventListener('click', (e) => { if (e.target === alertModal) hideAlert(); });
            askAiBtn.addEventListener('click', openAiModal);
            closeAiModalBtn.addEventListener('click', closeAiModal);
            aiModal.addEventListener('click', (e) => { if (e.target === aiModal) closeAiModal(); });
            generateAiPromptBtn.addEventListener('click', generateAiPrompt);
            copyAiPromptBtn.addEventListener('click', copyAiPrompt);

            initializeApp();
        }
    </script>
</body>
</html>
