<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editor Visual de Fórmulas LaTeX</title>
    
    <!-- Tailwind CSS para un diseño moderno y responsivo -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- MathJax para renderizar LaTeX -->
    <script>
        MathJax = {
          tex: {
            inlineMath: [['$', '$'], ['\\(', '\\)']],
            displayMath: [['$$', '$$'], ['\\[', '\\]']]
          },
          svg: {
            fontCache: 'global'
          }
        };
    </script>
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <!-- SortableJS para Drag and Drop -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    
    <style>
        body { font-family: 'Inter', sans-serif; }
        .preview-button { 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            min-height: 50px;
            padding: 0.5rem;
            font-size: 1.2rem; 
            transition: all 0.2s ease-in-out; 
            cursor: pointer; 
            width: 100%;
            overflow: hidden; /* Evita desbordamiento visual */
        }
        .preview-button:hover { transform: scale(1.05); box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        .highlight { transition: background-color 0.3s ease-in-out; background-color: #fefcbf !important; border-color: #facc15; }
        .drag-handle, .toggle-collapse-btn { cursor: pointer; }
        .drag-handle { padding: 0 8px; color: #9ca3af; }
        .drag-handle:hover { color: #1f2937; }
        .sortable-ghost { opacity: 0.4; background-color: #c7d2fe; }
        .preview-container.mathjax-processing { visibility: hidden; }
        .toggle-collapse-btn { transition: transform 0.2s ease-in-out; }
        .collapsed .toggle-collapse-btn { transform: rotate(-90deg); }
        /* Estilos para pestañas */
        .tab {
            transition: background-color 0.2s ease-in-out;
        }
        .tab.active {
            background-color: #4f46e5;
            color: white;
        }
        .tab-close-btn {
            display: none;
        }
        .tab:hover .tab-close-btn {
            display: inline-block;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <!-- Cabecera de la aplicación -->
    <header class="bg-white shadow-md p-4 sticky top-0 z-20 space-y-3">
        <div class="flex flex-wrap justify-between items-center gap-y-2">
            <h1 class="text-2xl font-bold text-gray-700">Editor de Fórmulas LaTeX</h1>
            <div class="flex items-center space-x-2 flex-wrap gap-y-2">
                <button id="ai-creator-btn" class="bg-cyan-500 text-white px-4 py-2 rounded-lg shadow hover:bg-cyan-600 transition">✨ Crear con IA</button>
                <button id="paste-btn" class="bg-yellow-500 text-white px-4 py-2 rounded-lg shadow hover:bg-yellow-600 transition">Pegar</button>
                <button id="copy-btn" class="bg-teal-500 text-white px-4 py-2 rounded-lg shadow hover:bg-teal-600 transition">Copiar JSON</button>
                <button id="export-btn" class="bg-purple-500 text-white px-4 py-2 rounded-lg shadow hover:bg-purple-600 transition">Exportar JSON</button>
            </div>
        </div>
        <div class="flex items-center space-x-2 border-b border-gray-200">
            <div id="tabs-container" class="flex items-center space-x-1">
                <!-- Las pestañas se generarán aquí -->
            </div>
            <button id="add-tab-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-600 font-bold py-1 px-3 rounded-full">+</button>
        </div>
         <div class="flex items-center space-x-2">
            <select id="category-navigator" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                <option value="">Ir a categoría...</option>
            </select>
            <button id="toggle-all-btn" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg shadow-sm hover:bg-gray-300 transition flex-shrink-0">Plegar/Desplegar</button>
        </div>
    </header>

    <!-- Contenedor principal -->
    <main class="grid grid-cols-1 md:grid-cols-2 gap-6 p-6">
        <div id="editor-container" class="bg-white p-4 rounded-lg shadow-inner overflow-auto h-[calc(100vh-255px)]"></div>
        <div id="preview-container" class="bg-white p-4 rounded-lg shadow-inner overflow-auto h-[calc(100vh-255px)]"></div>
    </main>
    
    <!-- Pie de página -->
    <footer class="text-center py-4 bg-gray-100 text-gray-600 text-sm">
        <p><a href="https://labia.tiddlyhost.com" target="_blank" class="hover:text-blue-600">Laboratorio de aplicaciones educativas</a> - <a href="https://bilateria.org" target="_blank" class="hover:text-blue-600">Aplicación hecha por Juan José de Haro</a></p>
        <p class="mt-1"><a href="https://creativecommons.org/licenses/by-sa/4.0/deed.es" target="_blank" class="hover:text-blue-600">Licencia Creative Commons BY-SA</a></p>
            <p class="mt-1">v4.28</p>
</footer>

    <!-- Modales -->
    <div id="modal-container">
        <div id="modal" class="fixed inset-0 bg-black bg-opacity-50 z-30 flex justify-center items-center hidden"><div class="bg-white p-6 rounded-lg shadow-2xl w-full max-w-md"><h2 id="modal-title" class="text-2xl font-bold mb-4"></h2><form id="modal-form"></form><div class="mt-6 flex justify-end space-x-3"><button id="modal-cancel" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-400 transition">Cancelar</button><button id="modal-save" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition">Guardar</button></div></div></div>
        <div id="confirm-modal" class="fixed inset-0 bg-black bg-opacity-50 z-40 flex justify-center items-center hidden"><div class="bg-white p-6 rounded-lg shadow-2xl w-full max-w-sm"><h2 id="confirm-title" class="text-xl font-bold mb-4"></h2><p id="confirm-message"></p><div class="mt-6 flex justify-end space-x-3"><button id="confirm-cancel" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-400 transition">Cancelar</button><button id="confirm-delete" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition">Eliminar</button></div></div></div>
        <div id="paste-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex justify-center items-center hidden"><div class="bg-white p-6 rounded-lg shadow-2xl w-full max-w-lg"><h2 class="text-2xl font-bold mb-4">Pegar contenido JSON</h2><div class="space-y-4"><textarea id="paste-textarea" rows="8" class="w-full border-gray-300 rounded-md font-mono text-sm" placeholder="Pega aquí el código JSON..."></textarea><div><label class="block text-sm font-medium text-gray-700">Tipo de contenido a pegar:</label><select id="paste-type" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"><option value="full">JSON Completo (en nueva pestaña)</option><option value="category">Categoría (en pestaña actual)</option><option value="element">Elemento(s) (en pestaña actual)</option></select></div><div id="paste-category-selector-div" class="hidden"><label class="block text-sm font-medium text-gray-700">Añadir elemento(s) a la categoría:</label><select id="paste-category-selector" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></select></div></div><div class="mt-6 flex justify-end space-x-3"><button id="paste-cancel" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-400 transition">Cancelar</button><button id="paste-add" class="bg-yellow-500 text-white px-4 py-2 rounded-lg hover:bg-yellow-600 transition">Añadir Contenido</button></div></div></div>
        <div id="ai-creator-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex justify-center items-center p-4 hidden"><div class="bg-white p-6 rounded-lg shadow-2xl w-full max-w-2xl flex flex-col max-h-[90vh]"><h2 class="text-2xl font-bold mb-4 flex-shrink-0">Asistente de Creación con IA</h2><div class="overflow-y-auto -mx-6 px-6"><div class="space-y-4"><div><label for="ai-choice" class="block text-sm font-medium text-gray-700">1. ¿Qué quieres crear?</label><select id="ai-choice" name="ai-choice" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"><option value="full_json">Archivo JSON completo</option><option value="category">Una sola categoría</option><option value="multiple_elements">Varios elementos</option></select></div><div id="ai-inputs-container" class="mt-4"></div></div><div class="mt-6"><h3 class="text-base font-medium text-gray-900">2. Genera y usa el prompt</h3><p class="text-sm text-gray-600 mt-1">Sigue los pasos para generar un prompt y obtener el código JSON de la IA que prefieras.</p><textarea id="ai-prompt-output" rows="5" class="w-full border-gray-300 rounded-md font-mono text-xs mt-2 bg-gray-50" readonly placeholder="Aquí aparecerá el prompt generado..."></textarea><div class="mt-2 space-y-2"><button id="ai-generate-prompt-btn" class="w-full bg-blue-600 text-white px-4 py-2 rounded-lg shadow hover:bg-blue-700 transition">1. Generar Prompt</button><div class="grid grid-cols-1 sm:grid-cols-2 gap-2"><button id="ai-launch-chatgpt-btn" class="w-full bg-green-600 text-white px-4 py-2 rounded-lg shadow hover:bg-green-700 transition disabled:bg-green-300 disabled:cursor-not-allowed" disabled>2. Lanzar en ChatGPT</button><button id="ai-copy-prompt-btn" class="w-full bg-gray-500 text-white px-4 py-2 rounded-lg shadow hover:bg-gray-600 transition disabled:bg-gray-300 disabled:cursor-not-allowed" disabled>2a. Copiar (otra IA)</button></div></div></div><div class="mt-6"><h3 class="text-base font-medium text-gray-900">3. Pega el resultado en el editor</h3><p class="text-sm text-gray-600 mt-1">Una vez tengas el código, cierra esta ventana y usa el botón <strong class="text-yellow-600">"Pegar"</strong> de la barra superior para añadir tu nueva creación.</p></div></div><div class="mt-auto pt-6 flex-shrink-0 flex justify-end"><button id="ai-creator-close-btn" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-400 transition">Cerrar</button></div></div></div>
        <div id="add-tab-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex justify-center items-center p-4 hidden"><div class="bg-white p-6 rounded-lg shadow-2xl w-full max-w-lg"><div class="flex justify-between items-center"><h2 class="text-2xl font-bold mb-4">Añadir conjunto de fórmulas</h2><button id="clear-cache-btn" class="text-sm text-blue-600 hover:underline">Limpiar caché</button></div><div class="space-y-4"><h3 class="text-lg font-medium text-gray-900">Menús disponibles</h3><div id="github-files-list" class="space-y-2 max-h-60 overflow-y-auto">Cargando lista...</div><hr class="my-4"><h3 class="text-lg font-medium text-gray-900">Otras fuentes</h3><div class="flex items-center space-x-2"><input type="url" id="custom-url-input" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" placeholder="Pegar URL de un JSON..."><button id="custom-url-load-btn" class="bg-indigo-500 text-white px-3 py-2 rounded-lg shadow-sm hover:bg-indigo-600 transition flex-shrink-0">Cargar</button></div><div class="mt-2"><label for="custom-file-input" class="w-full cursor-pointer bg-blue-500 text-white px-4 py-2 rounded-lg shadow hover:bg-blue-600 transition text-center block">Abrir archivo local...</label><input type="file" id="custom-file-input" class="hidden" accept=".json"></div></div><div class="mt-6 flex justify-end"><button id="add-tab-close-btn" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-400 transition">Cerrar</button></div></div></div>
    </div>

    <script type="module">
        const MANIFEST_URL = './menus.json';
        const DEFAULT_BASE_URL = './base.json';

        let tabs = [];
        let activeTabId = null;

        // --- DOM Elements ---
        const ui = {
            editorContainer: document.getElementById('editor-container'),
            previewContainer: document.getElementById('preview-container'),
            copyBtn: document.getElementById('copy-btn'),
            pasteBtn: document.getElementById('paste-btn'),
            exportBtn: document.getElementById('export-btn'),
            categoryNavigator: document.getElementById('category-navigator'),
            toggleAllBtn: document.getElementById('toggle-all-btn'),
            aiCreatorBtn: document.getElementById('ai-creator-btn'),
            tabsContainer: document.getElementById('tabs-container'),
            addTabBtn: document.getElementById('add-tab-btn'),
            // Modals
            modal: document.getElementById('modal'),
            modalTitle: document.getElementById('modal-title'),
            modalForm: document.getElementById('modal-form'),
            modalCancel: document.getElementById('modal-cancel'),
            modalSave: document.getElementById('modal-save'),
            confirmModal: document.getElementById('confirm-modal'),
            confirmTitle: document.getElementById('confirm-title'),
            confirmMessage: document.getElementById('confirm-message'),
            confirmCancel: document.getElementById('confirm-cancel'),
            confirmDelete: document.getElementById('confirm-delete'),
            pasteModal: document.getElementById('paste-modal'),
            pasteTextArea: document.getElementById('paste-textarea'),
            pasteType: document.getElementById('paste-type'),
            pasteCategorySelectorDiv: document.getElementById('paste-category-selector-div'),
            pasteCategorySelector: document.getElementById('paste-category-selector'),
            pasteCancel: document.getElementById('paste-cancel'),
            pasteAdd: document.getElementById('paste-add'),
            aiCreatorModal: document.getElementById('ai-creator-modal'),
            aiCreatorCloseBtn: document.getElementById('ai-creator-close-btn'),
            aiChoice: document.getElementById('ai-choice'),
            aiInputsContainer: document.getElementById('ai-inputs-container'),
            aiPromptOutput: document.getElementById('ai-prompt-output'),
            aiGeneratePromptBtn: document.getElementById('ai-generate-prompt-btn'),
            aiCopyPromptBtn: document.getElementById('ai-copy-prompt-btn'),
            aiLaunchChatGptBtn: document.getElementById('ai-launch-chatgpt-btn'),
            addTabModal: document.getElementById('add-tab-modal'),
            addTabCloseBtn: document.getElementById('add-tab-close-btn'),
            githubFilesList: document.getElementById('github-files-list'),
            clearCacheBtn: document.getElementById('clear-cache-btn'),
            customUrlInput: document.getElementById('custom-url-input'),
            customUrlLoadBtn: document.getElementById('custom-url-load-btn'),
            customFileInput: document.getElementById('custom-file-input'),
        };

        // --- Core Functions ---
        function getActiveTabData() {
            if (!activeTabId) return null;
            return tabs.find(t => t.id === activeTabId);
        }

        function setActiveTabData(newData) {
            const tabIndex = tabs.findIndex(t => t.id === activeTabId);
            if (tabIndex !== -1) {
                tabs[tabIndex].data = newData;
            }
        }

        function render() {
            const activeTab = getActiveTabData();
            const currentData = activeTab ? activeTab.data : { categorias: [] };
            renderEditor(currentData);
            renderPreview(currentData);
            renderCategoryNavigator(currentData);
            initDragAndDrop();
            renderTabs();
        }

        // --- Render UI ---
        function renderEditor(currentData) {
            ui.editorContainer.innerHTML = '';
            if (!currentData || !currentData.categorias || currentData.categorias.length === 0) {
                ui.editorContainer.innerHTML = '<p class="text-gray-500 text-center">Añade o carga un conjunto de fórmulas.</p>';
                return;
            }
            currentData.categorias.forEach((cat, catIndex) => {
                const isCollapsed = cat.isCollapsed || false;
                const categoryDiv = document.createElement('div');
                categoryDiv.className = `category-item mb-6 border border-gray-200 rounded-lg p-4 bg-gray-50 ${isCollapsed ? 'collapsed' : ''}`;
                categoryDiv.dataset.catId = catIndex;
                const header = document.createElement('div');
                header.className = 'flex justify-between items-center mb-3 pb-2 border-b';
                header.innerHTML = `<div class="flex items-center"><span class="drag-handle cat-drag-handle">&#9776;</span><span class="toggle-collapse-btn text-gray-500 hover:text-gray-800" data-cat-index="${catIndex}"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg></span><h3 class="text-xl font-semibold text-gray-700 ml-1">${cat.nombre}</h3></div><div class="space-x-2"><button data-cat-index="${catIndex}" class="edit-cat-btn text-blue-500 hover:text-blue-700" title="Editar categoría">&#9998;</button><button data-cat-index="${catIndex}" class="delete-cat-btn text-red-500 hover:text-red-700" title="Eliminar categoría">&#10006;</button><button data-cat-index="${catIndex}" class="add-el-btn bg-green-500 text-white text-sm px-3 py-1 rounded hover:bg-green-600" title="Añadir elemento">+</button></div>`;
                const elementsList = document.createElement('div');
                elementsList.className = 'elements-list space-y-2 pl-8';
                if (isCollapsed) elementsList.classList.add('hidden');
                elementsList.dataset.catIndex = catIndex;
                if(cat.elementos) {
                    cat.elementos.forEach((el, elIndex) => {
                        const elDiv = document.createElement('div');
                        elDiv.className = 'editor-item flex justify-between items-center p-2 rounded-md bg-white border border-gray-200 transition-colors duration-300';
                        elDiv.dataset.editorId = `${catIndex}-${elIndex}`;
                        elDiv.innerHTML = `<div class="flex items-center truncate"><span class="drag-handle el-drag-handle">&#9776;</span><div class="truncate"><strong class="text-sm font-medium">${el.title || el.type || 'Elemento'}</strong><p class="text-xs text-gray-500 truncate font-mono">${el.latex || ''}</p></div></div><div class="flex-shrink-0 space-x-2"><button data-cat-index="${catIndex}" data-el-index="${elIndex}" class="edit-el-btn text-blue-500 hover:text-blue-700" title="Editar elemento">&#9998;</button><button data-cat-index="${catIndex}" data-el-index="${elIndex}" class="delete-el-btn text-red-500 hover:text-red-700" title="Eliminar elemento">&#10006;</button></div>`;
                        elementsList.appendChild(elDiv);
                    });
                }
                categoryDiv.appendChild(header);
                categoryDiv.appendChild(elementsList);
                ui.editorContainer.appendChild(categoryDiv);
            });
            addEditorEventListeners();
        }

        function renderPreview(currentData) {
            ui.previewContainer.innerHTML = '';
            if (!currentData || !currentData.categorias || currentData.categorias.length === 0) {
                ui.previewContainer.innerHTML = '<p class="text-gray-500 text-center">Aquí aparecerá la vista previa.</p>';
                return;
            }
            currentData.categorias.forEach((cat, catIndex) => {
                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'mb-6 preview-category';
                categoryDiv.dataset.previewCatId = catIndex;
                categoryDiv.innerHTML = `<h3 class="text-xl font-semibold text-gray-700 mb-3">${cat.nombre}</h3>`;
                const gridDiv = document.createElement('div');
                gridDiv.className = 'grid gap-2';
                gridDiv.style.gridTemplateColumns = cat.grid_template_columns || 'repeat(auto-fit, minmax(80px, 1fr))';
                if(cat.elementos){
                    cat.elementos.forEach((el, elIndex) => {
                        if (el.type === 'custom_matrix') return;
                        const button = document.createElement('button');
                        button.className = 'preview-item preview-button bg-white border border-gray-300 rounded-md shadow-sm';
                        button.title = el.title || '';
                        button.dataset.catIndex = catIndex;
                        button.dataset.elIndex = elIndex;
                        const contentWrapper = document.createElement('div');
                        contentWrapper.className = 'math-content-wrapper';
                        contentWrapper.style.textAlign = 'center';
                        const latexToRender = el.display || el.latex;
                        contentWrapper.textContent = `\\(${latexToRender}\\)`;
                        button.appendChild(contentWrapper);
                        button.addEventListener('click', handlePreviewClick);
                        button.addEventListener('dblclick', handlePreviewDblClick);
                        gridDiv.appendChild(button);
                    });
                }
                categoryDiv.appendChild(gridDiv);
                ui.previewContainer.appendChild(categoryDiv);
            });
            
            if (typeof MathJax !== "undefined" && MathJax.typesetPromise) {
                ui.previewContainer.classList.add('mathjax-processing');
                MathJax.typesetPromise([ui.previewContainer])
                    .catch((err) => console.log('MathJax error: ' + err.message))
                    .finally(() => {
                        ui.previewContainer.classList.remove('mathjax-processing');
                        document.querySelectorAll('.preview-item').forEach(button => {
                            const mathContainer = button.querySelector('mjx-container');
                            if (mathContainer) {
                                const buttonWidth = button.clientWidth - 16;
                                const mathWidth = mathContainer.scrollWidth;
                                mathContainer.style.transform = 'scale(1)';
                                if (mathWidth > buttonWidth) {
                                    const scale = buttonWidth / mathWidth;
                                    mathContainer.style.transform = `scale(${scale})`;
                                    mathContainer.style.transformOrigin = 'center left';
                                }
                            }
                        });
                    });
            }
        }
        
        function renderCategoryNavigator(currentData) {
            ui.categoryNavigator.innerHTML = '<option value="">Ir a categoría...</option>';
            if (!currentData || !currentData.categorias || currentData.categorias.length === 0) {
                ui.categoryNavigator.disabled = true;
                return;
            }
            ui.categoryNavigator.disabled = false;
            currentData.categorias.forEach((cat, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = cat.nombre;
                ui.categoryNavigator.appendChild(option);
            });
        }
        
        // --- Tabs ---
        function renderTabs() {
            ui.tabsContainer.innerHTML = '';
            tabs.forEach(tab => {
                const tabEl = document.createElement('button');
                tabEl.className = `tab px-4 py-2 text-sm font-medium rounded-t-lg border-b-2 ${tab.id === activeTabId ? 'active border-indigo-500' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'}`;
                tabEl.textContent = tab.name;
                tabEl.dataset.tabId = tab.id;
                tabEl.addEventListener('click', () => switchTab(tab.id));
                if (tab.id !== 'base') {
                    const closeBtn = document.createElement('span');
                    closeBtn.className = 'tab-close-btn ml-2 text-xs font-bold';
                    closeBtn.innerHTML = '&times;';
                    closeBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        closeTab(tab.id);
                    });
                    tabEl.appendChild(closeBtn);
                }
                ui.tabsContainer.appendChild(tabEl);
            });
        }

        function switchTab(tabId) {
            activeTabId = tabId;
            render();
        }

        async function addTab(name, url, directData = null) {
            const existingTab = tabs.find(t => t.id === name);
            if (existingTab) {
                switchTab(name);
                return;
            }

            const tabId = name;
            const newTab = { id: tabId, name: name, url: url, data: { categorias: [] } };
            tabs.push(newTab);
            switchTab(tabId);
            
            if(directData){
                newTab.data = directData;
                render();
                return;
            }
            
            try {
                const cachedData = localStorage.getItem(`formula-cache-${name}`);
                if (cachedData) {
                    newTab.data = JSON.parse(cachedData);
                } else {
                    const response = await fetch(url);
                    if (!response.ok) throw new Error('Network response was not ok');
                    const jsonData = await response.json();
                    if (!jsonData.categorias) throw new Error('Invalid JSON format');
                    newTab.data = jsonData;
                    localStorage.setItem(`formula-cache-${name}`, JSON.stringify(jsonData));
                }
            } catch (error) {
                console.error(`Failed to load tab ${name}:`, error);
                alert(`No se pudo cargar el archivo para "${name}".`);
                closeTab(tabId); // Remove tab if loading failed
            }
            render();
        }

        function closeTab(tabId) {
            tabs = tabs.filter(t => t.id !== tabId);
            if (activeTabId === tabId) {
                switchTab('base');
            }
            render();
        }
        
        // --- Drag and Drop (FIXED) ---
        function initDragAndDrop() {
            // Sort categories
            new Sortable(ui.editorContainer, {
                animation: 150,
                handle: '.cat-drag-handle',
                ghostClass: 'sortable-ghost',
                onEnd: (evt) => {
                    // Use a deep copy to ensure immutability and prevent reference bugs.
                    const freshData = getActiveTabData()?.data;
                    if (!freshData || !freshData.categorias) return;

                    const newData = JSON.parse(JSON.stringify(freshData));
                    const [item] = newData.categorias.splice(evt.oldIndex, 1);
                    newData.categorias.splice(evt.newIndex, 0, item);
                    
                    setActiveTabData(newData);
                    render();
                }
            });

            // Sort elements within each category
            document.querySelectorAll('.elements-list').forEach(list => {
                const catIndex = list.dataset.catIndex;
                new Sortable(list, {
                    animation: 150,
                    handle: '.el-drag-handle',
                    ghostClass: 'sortable-ghost',
                    onEnd: (evt) => {
                        const freshData = getActiveTabData()?.data;
                        if (!freshData || !freshData.categorias || !freshData.categorias[catIndex]) return;

                        // Deep copy is safest for nested arrays.
                        const newData = JSON.parse(JSON.stringify(freshData));
                        
                        const [item] = newData.categorias[catIndex].elementos.splice(evt.oldIndex, 1);
                        newData.categorias[catIndex].elementos.splice(evt.newIndex, 0, item);
                        
                        setActiveTabData(newData);
                        render();
                    }
                });
            });
        }
        
        // --- Event Listeners & Handlers ---
        function addEditorEventListeners() {
            document.querySelectorAll('.toggle-collapse-btn').forEach(b => b.addEventListener('click', handleToggleCollapse));
            document.querySelectorAll('.edit-cat-btn').forEach(b => b.addEventListener('click', handleEditCategory));
            document.querySelectorAll('.delete-cat-btn').forEach(b => b.addEventListener('click', handleDeleteCategory));
            document.querySelectorAll('.add-el-btn').forEach(b => b.addEventListener('click', handleAddElement));
            document.querySelectorAll('.edit-el-btn').forEach(b => b.addEventListener('click', handleEditElement));
            document.querySelectorAll('.delete-el-btn').forEach(b => b.addEventListener('click', handleDeleteElement));
            document.querySelectorAll('.editor-item').forEach(item => item.addEventListener('click', handleEditorClick));
        }
        
        function handleToggleCollapse(e) {
            const catIndex = e.currentTarget.dataset.catIndex;
            const freshData = getActiveTabData().data;
            const newData = JSON.parse(JSON.stringify(freshData));
            newData.categorias[catIndex].isCollapsed = !newData.categorias[catIndex].isCollapsed;
            setActiveTabData(newData);
            render();
        }

        function highlightElements(editorItem, previewItem) {
            document.querySelectorAll('.highlight').forEach(el => el.classList.remove('highlight'));
            if(editorItem) editorItem.classList.add('highlight');
            if(previewItem) previewItem.classList.add('highlight');
            setTimeout(() => { if(editorItem) editorItem.classList.remove('highlight'); if(previewItem) previewItem.classList.remove('highlight'); }, 1500);
        }

        function handleEditorClick(e) {
            if (e.target.closest('button, .drag-handle, .toggle-collapse-btn')) return;
            const editorItem = e.currentTarget.closest('.editor-item');
            if (!editorItem) return;
            const { editorId } = editorItem.dataset;
            const [catIndex, elIndex] = editorId.split('-');
            const previewItem = document.querySelector(`.preview-item[data-cat-index="${catIndex}"][data-el-index="${elIndex}"]`);
            if (previewItem) { previewItem.scrollIntoView({ behavior: 'smooth', block: 'center' }); highlightElements(editorItem, previewItem); }
        }
        
        function handlePreviewClick(e) {
            const { catIndex, elIndex } = e.currentTarget.dataset;
            const freshData = getActiveTabData().data;
            const category = freshData.categorias[catIndex];

            if (category.isCollapsed) {
                const newData = JSON.parse(JSON.stringify(freshData));
                newData.categorias[catIndex].isCollapsed = false;
                setActiveTabData(newData);
                render();
                setTimeout(() => {
                    const editorItem = document.querySelector(`.editor-item[data-editor-id="${catIndex}-${elIndex}"]`);
                     if (editorItem) {
                        editorItem.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        highlightElements(editorItem, e.currentTarget);
                    }
                }, 0);
            } else {
                 const editorItem = document.querySelector(`.editor-item[data-editor-id="${catIndex}-${elIndex}"]`);
                 if (editorItem) {
                    editorItem.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    highlightElements(editorItem, e.currentTarget);
                }
            }
        }

        function handlePreviewDblClick(e) {
            const { catIndex, elIndex } = e.currentTarget.dataset;
            handleEditElement({ currentTarget: { dataset: { catIndex, elIndex } } });
        }
        
        // CRUD Handlers (FIXED with immutable pattern)
        function handleEditCategory(e) { const { catIndex } = e.currentTarget.dataset; showCategoryModal('Editar Categoría', getActiveTabData().data.categorias[catIndex], (formData) => { const newData = JSON.parse(JSON.stringify(getActiveTabData().data)); newData.categorias[catIndex] = {...newData.categorias[catIndex], ...formData}; setActiveTabData(newData); render(); }); }
        function handleDeleteCategory(e) { const { catIndex } = e.currentTarget.dataset; showConfirmModal(`Eliminar "${getActiveTabData().data.categorias[catIndex].nombre}"`, `¿Seguro?`, () => { const newData = JSON.parse(JSON.stringify(getActiveTabData().data)); newData.categorias.splice(catIndex, 1); setActiveTabData(newData); render(); }); }
        function handleAddElement(e) { const { catIndex } = e.currentTarget.dataset; showElementModal('Añadir Elemento', {}, (formData) => { const newData = JSON.parse(JSON.stringify(getActiveTabData().data)); if (!newData.categorias[catIndex].elementos) { newData.categorias[catIndex].elementos = []; } newData.categorias[catIndex].elementos.push({ type: "button", ...formData }); setActiveTabData(newData); render(); }); }
        function handleEditElement(e) { 
            const { catIndex, elIndex } = e.currentTarget.dataset;
            showElementModal('Editar Elemento', getActiveTabData().data.categorias[catIndex].elementos[elIndex], (formData) => {
                const newData = JSON.parse(JSON.stringify(getActiveTabData().data));
                newData.categorias[catIndex].elementos[elIndex] = {...newData.categorias[catIndex].elementos[elIndex], ...formData};
                setActiveTabData(newData);
                render();
            }, catIndex, elIndex);
        }
        function handleDeleteElement(e) { const { catIndex, elIndex } = e.currentTarget.dataset; const el = getActiveTabData().data.categorias[catIndex].elementos[elIndex]; showConfirmModal(`Eliminar "${el.title || el.latex}"`, `¿Seguro?`, () => { const newData = JSON.parse(JSON.stringify(getActiveTabData().data)); newData.categorias[catIndex].elementos.splice(elIndex, 1); setActiveTabData(newData); render(); }); }
        
        // Other Event Listeners
        ui.addTabBtn.addEventListener('click', async () => {
            ui.githubFilesList.innerHTML = 'Cargando lista...';
            ui.addTabModal.classList.remove('hidden');
            try {
                const response = await fetch(MANIFEST_URL);
                const filesData = await response.json();
                let files = Array.isArray(filesData) ? filesData : [];
                if (!Array.isArray(filesData) && filesData.menus) {
                    files = filesData.menus.map(item =>
                        (typeof item === 'string') ?
                        {name: item, download_url: './' + item} :
                        {name: item.file, download_url: './' + item.file}
                    );
                }
                if (!files || files.length === 0) {
                    ui.githubFilesList.innerHTML = `<p class="text-red-500">No se pudieron obtener menús.</p>`;
                    return;
                }
                const jsonFiles = files.filter(file => file.name.endsWith('.json'));
                ui.githubFilesList.innerHTML = '';
                if (jsonFiles.length === 0) {
                     ui.githubFilesList.innerHTML = `<p>No se encontraron archivos .json en la carpeta 'docs'.</p>`;
                }
                jsonFiles.forEach(file => {
                    const fileEl = document.createElement('button');
                    fileEl.className = 'w-full text-left p-2 rounded hover:bg-gray-100';
                    fileEl.textContent = file.name;
                    fileEl.addEventListener('click', () => {
                        addTab(file.name, file.download_url);
                        ui.addTabModal.classList.add('hidden');
                    });
                    ui.githubFilesList.appendChild(fileEl);
                });
            } catch (error) {
                console.error("Error fetching GitHub files:", error);
                ui.githubFilesList.innerHTML = `<p class="text-red-500">Error al cargar la lista.</p>`;
            }
        });
        ui.addTabCloseBtn.addEventListener('click', () => ui.addTabModal.classList.add('hidden'));
        ui.clearCacheBtn.addEventListener('click', () => {
            let clearedCount = 0;
            for (const key in localStorage) {
                if (key.startsWith('formula-cache-')) {
                    localStorage.removeItem(key);
                    clearedCount++;
                }
            }
            alert(`Caché de ${clearedCount} archivo(s) de fórmulas limpiada.`);
        });
        ui.customUrlLoadBtn.addEventListener('click', () => {
            const url = ui.customUrlInput.value.trim();
            if (url) {
                const name = url.substring(url.lastIndexOf('/') + 1) || 'URL Personalizada';
                addTab(name, url);
                ui.addTabModal.classList.add('hidden');
            } else {
                alert("Por favor, introduce una URL válida.");
            }
        });
        ui.customFileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const loadedData = JSON.parse(event.target.result);
                    if (loadedData.categorias && Array.isArray(loadedData.categorias)) {
                        addTab(file.name, null, loadedData);
                        ui.addTabModal.classList.add('hidden');
                    } else {
                        alert("El archivo JSON no tiene el formato esperado.");
                    }
                } catch (error) {
                    alert("Error al procesar el archivo JSON.");
                }
            };
            reader.readAsText(file);
            e.target.value = ''; // Reset for same-file uploads
        });


        ui.categoryNavigator.addEventListener('change', (e) => {
            const catIndex = e.target.value;
            if (catIndex === "") return;

            const editorCategoryDiv = ui.editorContainer.querySelector(`[data-cat-id='${catIndex}']`);
            const previewCategoryDiv = ui.previewContainer.querySelector(`[data-preview-cat-id='${catIndex}']`);

            if (editorCategoryDiv) {
                editorCategoryDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
                editorCategoryDiv.classList.add('highlight');
                setTimeout(() => editorCategoryDiv.classList.remove('highlight'), 1500);
            }
            if (previewCategoryDiv) {
                previewCategoryDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
                previewCategoryDiv.classList.add('highlight');
                setTimeout(() => previewCategoryDiv.classList.remove('highlight'), 1500);
            }
            e.target.value = ""; // Reset dropdown
        });

        ui.toggleAllBtn.addEventListener('click', () => {
            const freshData = getActiveTabData().data;
            if (!freshData.categorias || freshData.categorias.length === 0) return;

            const newData = JSON.parse(JSON.stringify(freshData));
            const shouldCollapse = newData.categorias.some(cat => !cat.isCollapsed);
            newData.categorias.forEach(cat => cat.isCollapsed = shouldCollapse);
            setActiveTabData(newData);
            render();
        });
        
        ui.copyBtn.addEventListener('click', () => {
            const currentData = getActiveTabData().data;
            if (currentData.categorias.length === 0) { alert("No hay nada que copiar."); return; }
            const jsonString = JSON.stringify(currentData, null, 2);
            navigator.clipboard.writeText(jsonString).then(() => {
                const originalText = ui.copyBtn.textContent;
                ui.copyBtn.textContent = '¡Copiado!';
                ui.copyBtn.classList.replace('bg-teal-500', 'bg-green-600');
                setTimeout(() => { ui.copyBtn.textContent = originalText; ui.copyBtn.classList.replace('bg-green-600', 'bg-teal-500'); }, 2000);
            }).catch(err => console.error('Error al copiar: ', err));
        });

        ui.exportBtn.addEventListener('click', () => {
            const currentData = getActiveTabData().data;
            if (currentData.categorias.length === 0) { alert("No hay nada que exportar."); return; }
            const a = document.createElement('a');
            a.href = URL.createObjectURL(new Blob([JSON.stringify(currentData, null, 2)], { type: 'application/json' }));
            a.download = `${activeTabId.replace('.json', '') || 'formulas'}.json`;
            a.click();
            URL.revokeObjectURL(a.href);
        });

        // --- Paste Logic ---
        ui.pasteBtn.addEventListener('click', () => {
            const currentData = getActiveTabData()?.data;
            ui.pasteTextArea.value = '';
            ui.pasteCategorySelector.innerHTML = '';
            if (currentData && currentData.categorias) {
                currentData.categorias.forEach((cat, index) => { const option = document.createElement('option'); option.value = index; option.textContent = cat.nombre; ui.pasteCategorySelector.appendChild(option); });
            }
            ui.pasteType.value = 'full';
            ui.pasteCategorySelectorDiv.classList.add('hidden');
            ui.pasteModal.classList.remove('hidden');
        });
        
        ui.pasteType.addEventListener('change', (e) => { 
            const isElement = e.target.value === 'element';
            ui.pasteCategorySelectorDiv.classList.toggle('hidden', !isElement);
        });

        ui.pasteCancel.addEventListener('click', () => ui.pasteModal.classList.add('hidden'));
        
        ui.pasteAdd.addEventListener('click', () => {
            const jsonText = ui.pasteTextArea.value.trim();
            if (!jsonText) { alert("El área de texto está vacía."); return; }
            
            try {
                const type = ui.pasteType.value;
                if (type === 'full') {
                    const pastedData = JSON.parse(jsonText);
                    if (pastedData.categorias && Array.isArray(pastedData.categorias)) {
                        addTab(`Pegado-${Date.now().toString().slice(-5)}`, null, pastedData);
                    } else { throw new Error("JSON completo inválido."); }
                } else {
                    // For category and element, we modify the current tab's data
                    const newData = JSON.parse(JSON.stringify(getActiveTabData().data));
                    if (type === 'category') {
                        const pastedData = JSON.parse(jsonText);
                        if (pastedData.nombre && pastedData.elementos) {
                            newData.categorias.push(pastedData);
                        } else { throw new Error("JSON de categoría inválido."); }
                    } else if (type === 'element') {
                        const catIndex = ui.pasteCategorySelector.value;
                        if (catIndex === '') { alert("Selecciona una categoría."); return; }
                        
                        let itemsToPaste = [];
                        try {
                            itemsToPaste = JSON.parse(`[${jsonText}]`);
                        } catch (e) {
                            throw new Error("El formato del elemento o de la lista de elementos es inválido. Asegúrate de que son objetos JSON válidos separados por comas.");
                        }

                        const validItems = itemsToPaste.filter(item => item.type && item.latex);
                        if (validItems.length > 0) {
                            if(!newData.categorias[catIndex].elementos) {
                               newData.categorias[catIndex].elementos = [];
                            }
                            newData.categorias[catIndex].elementos.push(...validItems);
                        } else {
                            throw new Error("Ningún elemento válido encontrado en el texto pegado.");
                        }
                    }
                    setActiveTabData(newData);
                    render();
                }
                ui.pasteModal.classList.add('hidden');
            } catch (error) {
                alert("Error al procesar el JSON: " + error.message);
            }
        });

        // --- AI Creator Modal Logic (UPDATED) ---
        const PROMPTS = {
            full_json: `Actúa como un experto en la creación de datos JSON estructurados para aplicaciones web. Tu tarea es generar un ARCHIVO JSON COMPLETO que contenga una lista de categorías de comandos LaTeX sobre un tema específico.\n\n**Estructura del Archivo JSON:**\nEl archivo debe empezar con \`{"categorias": [ ... ]}\` y contener un array de objetos de categoría.\n\n**Estructura de cada Categoría:**\n\`\`\`json\n{\n  "nombre": "string",  // El nombre visible de la categoría (ej. "Vectores").\n  "id": "string",        // Un identificador único en minúsculas (ej. "vectores").\n  "grid_template_columns": "string", // Valor CSS para la rejilla. Usa un valor de minmax adecuado a la anchura de las fórmulas. Para fórmulas anchas como integrales o estadística, usa "repeat(auto-fit, minmax(180px, 1fr))". Para letras griegas, "repeat(auto-fit, minmax(50px, 1fr))" es suficiente.\n  "isCollapsed": false, // Siempre 'false' para que aparezca desplegada.\n  "elementos": [       // Lista de los botones de la categoría.\n    {\n      "type": "button",          // Siempre "button".\n      "latex": "string",         // El código LaTeX real que se inserta (ej. "\\\\vec{}").\n      "display": "string",       // Código LaTeX para mostrar en el botón, debe ser un ejemplo válido (ej. "\\\\vec{a}"). Si se omite, se usa "latex".\n      "title": "string"          // Un texto corto que describe la fórmula (ej. "Vector").\n    }\n  ]\n}\n\`\`\`\n\n**REGLA VITAL:** Dentro del JSON, cada barra invertida \`\\\` del código LaTeX original debe ser representada como UNA DOBLE BARRA INVERTIDA \`\\\\\`. Por ejemplo, si el comando es \`\\frac\`, en el JSON debe escribirse como \`"latex": "\\\\frac{}{}"\`. NUNCA uses CUATRO barras invertidas.\n\n**Instrucciones:**\n1. Basándote en el tema general y las instrucciones adicionales, crea una estructura de categorías y elementos coherente.\n2. Genera el JSON completo, empezando por \`{"categorias": [ ... ]}\`.\n3. Tu respuesta debe ser únicamente el bloque de código JSON, sin añadir ninguna explicación o texto adicional.\n\n**Tema General:**\n{THEME}\n\n**Instrucciones Adicionales para la IA (opcional):**\n{INSTRUCTIONS}`,
            category: `Actúa como un experto en la creación de datos JSON estructurados para aplicaciones web. Tu tarea es generar un único objeto JSON que represente una categoría de comandos LaTeX.\n\n**Estructura y campos del JSON (explicación):**\n\`\`\`json\n{\n  "nombre": "string",  // El nombre visible de la categoría (ej. "Vectores").\n  "id": "string",        // Un identificador único en minúsculas (ej. "vectores").\n  "grid_template_columns": "string", // Valor CSS para la rejilla. Usa un valor de minmax adecuado a la anchura de las fórmulas. Para fórmulas anchas como integrales o estadística, usa "repeat(auto-fit, minmax(180px, 1fr))". Para letras griegas, "repeat(auto-fit, minmax(50px, 1fr))" es suficiente.\n  "isCollapsed": false, // Siempre 'false' para que aparezca desplegada.\n  "elementos": [       // Lista de los botones de la categoría.\n    {\n      "type": "button",          // Siempre "button".\n      "latex": "string",         // El código LaTeX real que se inserta (ej. "\\\\vec{}").\n      "display": "string",       // Código LaTeX para mostrar en el botón, debe ser un ejemplo válido (ej. "\\\\vec{a}"). Si se omite, se usa "latex".\n      "title": "string"          // Un texto corto que describe la fórmula (ej. "Vector").\n    }\n  ]\n}\n\`\`\`\n\n**REGLA VITAL:** Dentro del JSON, cada barra invertida \`\\\` del código LaTeX original debe ser representada como UNA DOBLE BARRA INVERTIDA \`\\\\\`. Por ejemplo, si el comando es \`\\frac\`, en el JSON debe escribirse como \`"latex": "\\\\frac{}{}"\`. NUNCA uses CUATRO barras invertidas.\n\n**Instrucciones:**\n1. Basándote en el tema que te doy a continuación y las instrucciones adicionales, crea una lista de comandos LaTeX relevantes.\n2. Genera un único objeto JSON que siga la estructura y las reglas anteriores.\n3. Tu respuesta debe ser únicamente el bloque de código JSON, sin añadir ninguna explicación o texto adicional.\n\n**Tema de la categoría:**\n{THEME}\n\n**Instrucciones Adicionales para la IA (opcional):**\n{INSTRUCTIONS}`,
            multiple_elements: `Actúa como un experto en la creación de datos JSON estructurados para aplicaciones web. Tu tarea es generar una lista de objetos JSON que representen comandos LaTeX para botones.\n\n**Estructura y campos del JSON (explicación):**\n\`\`\`json\n{\n  "type": "button",          // Siempre "button".\n  "latex": "string",         // El código LaTeX real que se inserta (ej. "\\\\vec{}").\n  "display": "string",       // Código LaTeX para mostrar en el botón, debe ser un ejemplo válido (ej. "\\\\vec{a}"). Si se omite, se usa "latex".\n  "title": "string"          // Un texto corto que describe la fórmula (ej. "Vector").\n}\n\`\`\`\n\n**REGLA VITAL:** Dentro del JSON, cada barra invertida \`\\\` del código LaTeX original debe ser representada como UNA DOBLE BARRA INVERTIDA \`\\\\\`. Por ejemplo, si el comando es \`\\frac\`, en el JSON debe escribirse como \`"latex": "\\\\frac{}{}"\`. NUNCA uses CUATRO barras invertidas.\n\n**Instrucciones:**\n1. Basándote en el tema que te proporciono y las instrucciones adicionales, crea una lista de objetos JSON de comandos LaTeX relevantes.\n2. Los objetos deben estar separados por comas.\n3. Tu respuesta debe ser únicamente la lista de objetos JSON, sin envolverla en un array \`[]\` y sin texto adicional.\n\n**Tema de los elementos:**\n{THEME}\n\n**Instrucciones Adicionales para la IA (opcional):**\n{INSTRUCTIONS}`
        };
        
        function resetAiModal() { ui.aiPromptOutput.value = ''; ui.aiLaunchChatGptBtn.disabled = true; ui.aiCopyPromptBtn.disabled = true; }
        
        ui.aiCreatorBtn.addEventListener('click', () => { renderAiCreatorInputs('full_json'); resetAiModal(); ui.aiCreatorModal.classList.remove('hidden'); });
        
        ui.aiCreatorCloseBtn.addEventListener('click', () => ui.aiCreatorModal.classList.add('hidden'));
        
        ui.aiChoice.addEventListener('change', (e) => { renderAiCreatorInputs(e.target.value); resetAiModal(); });
        
        function renderAiCreatorInputs(choice) {
            let html = '';
            const instructionsHTML = `<div><label for="ai-instructions" class="block text-sm font-medium text-gray-700 mt-2">Instrucciones adicionales para la IA (opcional):</label><textarea id="ai-instructions" rows="3" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md" placeholder="Ej: Crear 3 categorías con 5 fórmulas cada una. O crear 8 elementos sobre..."></textarea></div>`;
            
            switch(choice) {
                case 'full_json':
                    html = `<div><label for="ai-theme" class="block text-sm font-medium text-gray-700 mt-2">Tema general:</label><input type="text" id="ai-theme" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md" placeholder="Ej: Estadística, Álgebra Lineal..."></div>`;
                    break;
                case 'category':
                    html = `<div><label for="ai-theme" class="block text-sm font-medium text-gray-700 mt-2">Tema de la categoría:</label><input type="text" id="ai-theme" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md" placeholder="Ej: Vectores, Química Orgánica..."></div>`;
                    break;
                case 'multiple_elements':
                    html = `<div><label for="ai-theme" class="block text-sm font-medium text-gray-700 mt-2">Tema de los elementos:</label><input type="text" id="ai-theme" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md" placeholder="Ej: Identidades trigonométricas"></div>`;
                    break;
            }
            ui.aiInputsContainer.innerHTML = html + instructionsHTML;
        }

        function generatePromptText() {
            let prompt = '';
            const choice = ui.aiChoice.value;
            const instructions = document.getElementById('ai-instructions').value.trim();
            const defaultInstructions = 'Ninguna.';
            let theme = '';

            switch(choice) {
                case 'full_json':
                case 'category':
                case 'multiple_elements':
                    theme = document.getElementById('ai-theme').value.trim();
                    if (!theme) { alert("Por favor, introduce un tema."); return null; }
                    prompt = PROMPTS[choice]
                        .replace('{THEME}', theme)
                        .replace('{INSTRUCTIONS}', instructions || defaultInstructions);
                    break;
            }
            return prompt;
        }
        
        ui.aiGeneratePromptBtn.addEventListener('click', () => { const promptText = generatePromptText(); if (promptText) { ui.aiPromptOutput.value = promptText; ui.aiLaunchChatGptBtn.disabled = false; ui.aiCopyPromptBtn.disabled = false; } });
        ui.aiCopyPromptBtn.addEventListener('click', () => { const promptText = ui.aiPromptOutput.value; if (!promptText) { return; } navigator.clipboard.writeText(promptText).then(() => { const originalText = ui.aiCopyPromptBtn.textContent; const originalClasses = [...ui.aiCopyPromptBtn.classList]; ui.aiCopyPromptBtn.textContent = "¡Copiado!"; ui.aiCopyPromptBtn.classList.remove('bg-gray-500', 'hover:bg-gray-600'); ui.aiCopyPromptBtn.classList.add('bg-green-600'); setTimeout(() => { ui.aiCopyPromptBtn.textContent = originalText; ui.aiCopyPromptBtn.className = ''; originalClasses.forEach(c => ui.aiCopyPromptBtn.classList.add(c)); }, 2000); }).catch(err => { console.error('Error al copiar: ', err); alert("No se pudo copiar el prompt."); }); });
        ui.aiLaunchChatGptBtn.addEventListener('click', () => { const promptText = ui.aiPromptOutput.value; if (!promptText) { return; } const chatGptUrl = `https://chatgpt.com/?q=${encodeURIComponent(promptText)}`; window.open(chatGptUrl, '_blank'); });

        // --- Modals Generic Handlers ---
        let onSaveCallback = null;
        function showCategoryModal(title, categoryData = {}, onSave) { ui.modalTitle.textContent = title; ui.modalForm.innerHTML = `<div class="space-y-4"><div><label for="cat-nombre" class="block text-sm font-medium text-gray-700">Nombre</label><input type="text" id="cat-nombre" value="${categoryData.nombre || ''}" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" required></div><div><label for="cat-grid" class="block text-sm font-medium text-gray-700">CSS Grid Template</label><input type="text" id="cat-grid" value="${categoryData.grid_template_columns || 'repeat(auto-fit, minmax(80px, 1fr))'}" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" required></div></div>`; onSaveCallback = () => { const formData = { nombre: document.getElementById('cat-nombre').value, grid_template_columns: document.getElementById('cat-grid').value }; if (!formData.nombre) { alert('El nombre es obligatorio.'); return; } onSave(formData); hideModal(); }; ui.modal.classList.remove('hidden'); }
        
        function showElementModal(title, elementData = {}, onSave, catIndex, elIndex) {
            ui.modalTitle.textContent = title;
            ui.modalForm.innerHTML = `<div class="space-y-4"><div><label for="el-title" class="block text-sm font-medium">Título</label><input type="text" id="el-title" value="${elementData.title || ''}" class="mt-1 block w-full px-3 py-2 border rounded-md" required></div><div><label for="el-latex" class="block text-sm font-medium">LaTeX (insertar)</label><textarea id="el-latex" rows="3" class="mt-1 block w-full px-3 py-2 border rounded-md font-mono" required>${elementData.latex || ''}</textarea></div><div><label for="el-display" class="block text-sm font-medium">LaTeX (visualizar)</label><textarea id="el-display" rows="3" class="mt-1 block w-full px-3 py-2 border rounded-md font-mono">${elementData.display || ''}</textarea><p class="text-xs text-gray-500 mt-1">Opcional. Si se deja en blanco, se usa el de insertar.</p></div></div>`;
            
            if (catIndex !== undefined && elIndex !== undefined) {
                const moveContainer = document.createElement('div');
                moveContainer.className = 'mt-6 pt-4 border-t border-gray-200 space-y-2';
                moveContainer.innerHTML = `<label for="move-el-category" class="block text-sm font-medium text-gray-700">Mover a otra categoría</label>`;

                const moveControls = document.createElement('div');
                moveControls.className = 'flex items-center space-x-2';

                const selectEl = document.createElement('select');
                selectEl.id = 'move-el-category';
                selectEl.className = 'block w-full rounded-md border-gray-300 shadow-sm';
                getActiveTabData().data.categorias.forEach((cat, index) => {
                    const option = document.createElement('option');
                    option.value = index;
                    option.textContent = cat.nombre;
                    if (index === parseInt(catIndex)) {
                        option.selected = true;
                    }
                    selectEl.appendChild(option);
                });

                const moveBtn = document.createElement('button');
                moveBtn.type = 'button';
                moveBtn.textContent = 'Mover';
                moveBtn.className = 'bg-orange-500 text-white px-3 py-2 rounded-lg shadow-sm hover:bg-orange-600 transition text-sm';

                moveBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    const newCatIndex = parseInt(selectEl.value, 10);
                    if (newCatIndex !== parseInt(catIndex, 10)) {
                        const newData = JSON.parse(JSON.stringify(getActiveTabData().data));
                        const [elementToMove] = newData.categorias[catIndex].elementos.splice(elIndex, 1);
                        newData.categorias[newCatIndex].elementos.push(elementToMove);
                        setActiveTabData(newData);
                        hideModal();
                        render();
                    } else {
                        alert("Ya se encuentra en esta categoría.");
                    }
                });

                moveControls.appendChild(selectEl);
                moveControls.appendChild(moveBtn);
                moveContainer.appendChild(moveControls);
                ui.modalForm.appendChild(moveContainer);
            }

            onSaveCallback = () => {
                const formData = { title: document.getElementById('el-title').value, latex: document.getElementById('el-latex').value, display: document.getElementById('el-display').value };
                if (!formData.title || !formData.latex) { alert('Título y LaTeX son obligatorios.'); return; }
                onSave(formData);
                hideModal();
            };
            ui.modal.classList.remove('hidden');
        }

        function hideModal() { ui.modal.classList.add('hidden'); onSaveCallback = null; }
        ui.modalSave.addEventListener('click', () => { if (onSaveCallback) onSaveCallback(); });
        ui.modalCancel.addEventListener('click', hideModal);
        
        let onDeleteCallback = null;
        function showConfirmModal(title, message, onDelete) { ui.confirmTitle.textContent = title; ui.confirmMessage.textContent = message; onDeleteCallback = onDelete; ui.confirmModal.classList.remove('hidden'); }
        function hideConfirmModal() { ui.confirmModal.classList.add('hidden'); onDeleteCallback = null; }
        ui.confirmDelete.addEventListener('click', () => { if(onDeleteCallback) onDeleteCallback(); hideConfirmModal(); });
        ui.confirmCancel.addEventListener('click', hideConfirmModal);

        // --- Initial Load ---
        async function init() {
            const baseTab = { id: 'base', name: 'Base', url: DEFAULT_BASE_URL, data: { categorias: [] } };
            tabs.push(baseTab);
            activeTabId = 'base';
            try {
                const response = await fetch(DEFAULT_BASE_URL);
                if (!response.ok) throw new Error('Failed to load base formulas');
                const jsonData = await response.json();
                if (jsonData && jsonData.categorias) {
                    baseTab.data = jsonData;
                }
            } catch(error) {
                console.error("Could not load base formulas:", error);
                alert("No se pudieron cargar las fórmulas base por defecto.");
            }
            render();
            renderAiCreatorInputs('full_json'); // Render initial inputs for AI creator
        }

        init();
    </script>
</body>
</html>
